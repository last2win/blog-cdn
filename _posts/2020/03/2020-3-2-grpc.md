---
layout: post
title: "grpc与protobuf最佳实践:编译、安装与使用"
categories: [rpc]
description: ""
permalink: /grpc-and-protobuf/
---

此文首发于我的Jekyll博客：[zhang0peter的个人博客](https://zhang0peter.com)         

{% raw %}
***          
{% endraw %}

最近要用到`grpc`，因此写一篇关于 grpc 静态编译和使用的文章

## 下载
安装需要的软件：
```sh
apt install make gcc g++ cmake build-essential autoconf libtool pkg-config git unzip
```
下载库：
```sh
#记得改为最新版本的 grpc
git clone -b v1.27.3 https://github.com/grpc/grpc
cd grpc
git submodule update --init --recursive
```

## 安装 protobuf-protoc
google的grpc使用的`protobuf`作为序列化数据的格式。

推荐编译安装：
```sh
cd third_party/protobuf 
./autogen.sh
./configure
make -j 2
sudo make install
sudo ldconfig # refresh shared library cache.
```


或者直接从网上下载最新版本的`protobuf`:
```sh
#! /bin/bash
# Make sure you grab the latest version
curl -OL https://github.com/google/protobuf/releases/download/v3.11.4/protoc-3.11.4-linux-x86_64.zip

# Unzip
unzip protoc-3.11.4-linux-x86_64.zip -d protoc3
# Move protoc to /usr/local/bin/
sudo cp -r protoc3/bin/* /usr/local/bin/
# Move protoc3/include to /usr/local/include/
sudo cp -r protoc3/include/* /usr/local/include/
# Optional: change owner
sudo chown $USER /usr/local/bin/protoc
sudo chown -R $USER /usr/local/include/google

sudo ldconfig # refresh shared library cache.
```
```sh
-> # protoc --version
libprotoc 3.11.4
```




不推荐直接安装`protoc`，库中的`protoc`版本比较旧：
```sh
apt install libprotobuf-dev protobuf-compiler

-> # protoc --version
libprotoc 3.0.0
```

## 静态编译 grpc/ static link build grpc


```sh
export CFLAGS='-Wno-implicit-fallthrough'
export CXXFLAGS='-Wno-expansion-to-defined -Wno-implicit-fallthrough'
make REQUIRE_CUSTOM_LIBRARIES_opt=1 static
```
注意：如果安装`grpc`到系统目录后，无法轻易卸载

```sh
sudo make install
```
## 测试

**警告：如果测试通不过，后续就不用做了，重装系统吧**

```sh
cd examples/cpp/helloworld/
make
```
```sh
# ./greeter_server 
Server listening on 0.0.0.0:50051
```
```sh
~/grpc/examples/cpp/helloworld$ ./greeter_client 
Greeter received: Hello world
```
## 自己编写 Protobuf 文件

`helloworld.proto` :
```proto
syntax = "proto3";

package helloworld;

// The greeting service definition.
service Greeter {
  // Sends a greeting
  rpc SayHello (HelloRequest) returns (HelloReply) {}
}

// The request message containing the user's name.
message HelloRequest {
  string name = 1;
}

// The response message containing the greetings
message HelloReply {
  string message = 1;
}
```
编译：
```sh
protoc helloworld.proto --cpp_out=./
protoc helloworld.proto --grpc_out=./ --plugin=protoc-gen-grpc=/usr/local/bin/grpc_cpp_plugin
```
编译完成后文件列表如下：
```sh
-> % ls
helloworld.grpc.pb.cc  helloworld.grpc.pb.h  helloworld.pb.cc  helloworld.pb.h  helloworld.proto
```
服务器端代码 `server.cpp`:
```c

```
